name: Build and release

on:
  workflow_dispatch:
    inputs:
      version_r:
        description: "R versions to build (36, 40, 41, 42, 43 valid)"
        required: true
        default: "36,40,41,42,43"
      version_image:
        description: "Version of image (vx.y or dev valid)"
        required: true
        default: "dev"

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}

    steps:
    - name: Check out code
      uses: actions/checkout@v4
    
    - name: Install apptainer
      run: .devcontainer/scripts/install-apptainer.sh

    - name: Build and release manually-selected versions
      if: github.event_name == 'workflow_dispatch'
      run: |
        echo "Creating new images for manually-selected versions"
        set -e
        IFS=',' read -ra VERSIONS_R <<< "${{ github.event.inputs.version_r }}"
        for VERSION_R in "${VERSIONS_R[@]}"; do
          echo "Building version $VERSION_R"
          IFS=',' read -ra VERSIONS_IMAGE <<< "${{ github.event.inputs.version_image }}"
          for VERSION_IMAGE in "${VERSIONS_IMAGE[@]}"; do
            echo "Building version $VERSION_R with image $VERSION_IMAGE"
            ./build_and_release.sh "$VERSION_R" "$VERSION_IMAGE"
          done
        done
